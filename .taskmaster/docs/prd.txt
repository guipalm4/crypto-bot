# PRD - Rob√¥ de Trading de Criptomoedas (Crypto Trading Bot)

## üìã Vis√£o Geral do Projeto

### Objetivo
Desenvolver um rob√¥ de trading automatizado em Python capaz de executar opera√ß√µes de compra e venda de criptoativos em m√∫ltiplas corretoras, com arquitetura modular baseada em plugins, gest√£o de risco robusta e parametriza√ß√£o completa.

### Stack Tecnol√≥gico
- **Linguagem**: Python 3.12+ (vers√£o mais recente e est√°vel)
- **Database**: PostgreSQL 16+
- **ORM**: SQLAlchemy 2.x (√∫ltima vers√£o)
- **Valida√ß√£o**: Pydantic 2.x
- **Exchange Integration**: CCXT 4.x
- **Testing**: pytest, pytest-asyncio
- **Code Quality**: black, flake8, mypy, isort
- **Architecture**: Domain-Driven Design (DDD)

### Princ√≠pios de Desenvolvimento
- C√≥digo modular e desacoplado
- PEP 8 compliance
- Type hints em todo o c√≥digo
- Testes unit√°rios e de integra√ß√£o
- Documenta√ß√£o inline (docstrings)
- Configuration over hardcoding
- Plugin-based architecture
- Security by design

---

## üéØ MVP - Escopo de 1 M√™s

### Funcionalidades Priorit√°rias

#### 1. Core Trading Engine
**Contexto**: Motor principal de execu√ß√£o de trades
**Requisitos**:
- Executar ordens de compra (market e limit orders)
- Executar ordens de venda (market e limit orders)
- Cancelar ordens abertas
- Consultar status de ordens
- Verificar saldo dispon√≠vel
- **Par√¢metros configur√°veis**:
  - Tipo de ordem (market/limit)
  - Quantidade a negociar
  - Pre√ßo limite (para limit orders)
  - Timeout de ordem
  - Retry policy (tentativas, intervalo)

#### 2. Sistema de Registro e Persist√™ncia
**Contexto**: Rastreabilidade completa de todas as opera√ß√µes
**Requisitos**:
- Registrar todas as ordens executadas
- Armazenar hist√≥rico de pre√ßos
- Salvar snapshots de carteira
- Registrar eventos do sistema
- **Dados a persistir**:
  - ID da ordem na exchange
  - Timestamp de cria√ß√£o e execu√ß√£o
  - Par de trading (ex: BTC/USDT)
  - Tipo (compra/venda)
  - Quantidade
  - Pre√ßo de execu√ß√£o
  - Taxas (fees)
  - Status (pending/filled/cancelled/failed)
  - Exchange utilizada
  - Estrat√©gia aplicada
  - Raz√£o da opera√ß√£o

#### 3. Gest√£o de Risco B√°sica
**Contexto**: Prote√ß√£o do capital e controle de exposi√ß√£o
**Requisitos**:
- Stop Loss autom√°tico
- Take Profit autom√°tico
- Limite de exposi√ß√£o por ativo
- Limite de exposi√ß√£o por exchange
- **Par√¢metros configur√°veis**:
  - Percentual de stop loss (ex: 2%, 5%, 10%)
  - Percentual de take profit (ex: 3%, 5%, 10%, 20%)
  - Percentual m√°ximo de capital por trade (ex: 5%, 10%)
  - Percentual m√°ximo de capital por ativo (ex: 20%, 30%)
  - Percentual m√°ximo de capital por exchange (ex: 50%)
  - Stop loss trailing (ativo/inativo, dist√¢ncia)
  - M√°ximo de trades simult√¢neos
  - Drawdown m√°ximo permitido

#### 4. Plugin System - Exchanges
**Contexto**: Suporte multi-exchange via arquitetura de plugins
**Requisitos**:
- Interface abstrata para exchanges
- Implementar plugins para 2 exchanges no MVP:
  - Binance (maior liquidez)
  - Coinbase (alternativa popular)
- **Funcionalidades por plugin**:
  - Autentica√ß√£o via API keys
  - Fetch de orderbook
  - Fetch de ticker price
  - Fetch de hist√≥rico OHLCV
  - Executar ordens
  - Consultar ordens
  - Consultar saldo
- **Par√¢metros configur√°veis por exchange**:
  - API Key
  - API Secret
  - Passphrase (se necess√°rio)
  - Testnet/Sandbox mode
  - Rate limits
  - Timeout
  - Proxy (opcional)

#### 5. Plugin System - Indicadores T√©cnicos
**Contexto**: An√°lise t√©cnica modular via plugins
**Requisitos**:
- Interface abstrata para indicadores
- Implementar 3 indicadores no MVP:
  - **RSI (Relative Strength Index)**:
    - Per√≠odo (padr√£o: 14)
    - Zona de sobrevenda (padr√£o: 30)
    - Zona de sobrecompra (padr√£o: 70)
  - **MACD (Moving Average Convergence Divergence)**:
    - Fast period (padr√£o: 12)
    - Slow period (padr√£o: 26)
    - Signal period (padr√£o: 9)
  - **EMA (Exponential Moving Average)**:
    - Per√≠odo (padr√£o: 20, 50, 200)
- Sistema de cache de indicadores calculados
- **Par√¢metros configur√°veis por indicador**: todos os per√≠odos e thresholds

#### 6. Plugin System - Estrat√©gias
**Contexto**: L√≥gica de decis√£o modular via plugins
**Requisitos**:
- Interface abstrata para estrat√©gias
- Implementar 2 estrat√©gias simples no MVP:
  - **RSI Mean Reversion**:
    - Compra quando RSI < 30
    - Vende quando RSI > 70
    - Par√¢metros: per√≠odo RSI, thresholds
  - **MACD Crossover**:
    - Compra quando MACD cruza acima da linha de sinal
    - Vende quando MACD cruza abaixo da linha de sinal
    - Par√¢metros: per√≠odos MACD
- **Par√¢metros configur√°veis**:
  - Indicadores utilizados e seus par√¢metros
  - Regras de entrada (condi√ß√µes para compra)
  - Regras de sa√≠da (condi√ß√µes para venda)
  - Timeframe de an√°lise
  - Ativo(s) a operar

#### 7. Sistema de Configura√ß√£o
**Contexto**: Centraliza√ß√£o de par√¢metros em arquivos de configura√ß√£o
**Requisitos**:
- Arquivo de configura√ß√£o em YAML/JSON
- Suporte a m√∫ltiplos perfis (dev, staging, production)
- Vari√°veis de ambiente para dados sens√≠veis
- Valida√ß√£o de configura√ß√£o com Pydantic
- **Configura√ß√µes principais**:
  - Exchanges ativas e credenciais
  - Estrat√©gias ativas e par√¢metros
  - Regras de gest√£o de risco
  - Ativos a operar
  - Timeframes
  - Logging level
  - Database connection

#### 8. Logging e Monitoramento B√°sico
**Contexto**: Observabilidade para debugging e auditoria
**Requisitos**:
- Structured logging (JSON format)
- N√≠veis: DEBUG, INFO, WARNING, ERROR, CRITICAL
- Logs separados por m√≥dulo
- Rota√ß√£o de logs
- **Eventos a logar**:
  - Inicializa√ß√£o do sistema
  - Conex√£o com exchanges
  - Execu√ß√£o de estrat√©gias
  - Sinais de compra/venda
  - Execu√ß√£o de ordens
  - Erros e exce√ß√µes
  - Mudan√ßas de estado

#### 9. CLI B√°sica
**Contexto**: Interface de linha de comando para opera√ß√£o
**Requisitos**:
- Iniciar/parar o bot
- Listar estrat√©gias ativas
- Listar posi√ß√µes abertas
- Verificar saldo
- For√ßar execu√ß√£o de estrat√©gia
- Visualizar logs em tempo real
- Dry-run mode (simula√ß√£o sem execu√ß√£o real)

---

## üèóÔ∏è Arquitetura T√©cnica

### Estrutura de Diret√≥rios (DDD-Inspired)

```
cripto-bot/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ domain/                    # Regras de neg√≥cio puras
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/              # Entidades de dom√≠nio
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ position.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trade.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ asset.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ portfolio.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ value_objects/         # Value objects imut√°veis
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ price.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quantity.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ percentage.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ timeframe.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ events/                # Domain events
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ order_executed.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stop_loss_triggered.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ signal_generated.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ application/               # Use cases e orquestra√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trading_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ risk_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategy_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backtest_service.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dto/                   # Data Transfer Objects
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ order_dto.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ trade_dto.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/            # Implementa√ß√µes t√©cnicas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/           # SQLAlchemy models
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/     # Repository pattern
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/       # Alembic migrations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exchanges/            # Exchange adapters
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binance.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ coinbase.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ external/             # APIs externas
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ plugins/                   # Sistema de plugins
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ indicators/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rsi.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ macd.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ema.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rsi_mean_reversion.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ macd_crossover.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ registry.py           # Plugin loader/registry
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ config/                    # Configura√ß√µes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.yaml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.py            # Pydantic schemas
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ utils/                     # Utilit√°rios
‚îÇ       ‚îú‚îÄ‚îÄ logging.py
‚îÇ       ‚îú‚îÄ‚îÄ decorators.py
‚îÇ       ‚îî‚îÄ‚îÄ validators.py
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ e2e/
‚îÇ
‚îú‚îÄ‚îÄ docs/                          # Documenta√ß√£o
‚îú‚îÄ‚îÄ scripts/                       # Scripts utilit√°rios
‚îú‚îÄ‚îÄ alembic/                       # Database migrations
‚îú‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ docker-compose.yml
```

---

## üîí Seguran√ßa

### Pr√°ticas Obrigat√≥rias

1. **Credenciais**
   - Nunca hardcode API keys
   - Usar vari√°veis de ambiente
   - Criptografar credenciais no banco (AES-256)
   - Rota√ß√£o peri√≥dica de keys

2. **API Keys Permissions**
   - Usar API keys somente-leitura para backtest
   - Nunca habilitar saque (withdrawal) nas API keys
   - IP whitelist quando poss√≠vel

3. **Code Security**
   - Input validation em todos os endpoints
   - SQL injection prevention (usar ORM)
   - Rate limiting
   - Dependency scanning (safety, bandit)

4. **Operational Security**
   - Logs n√£o devem conter dados sens√≠veis
   - Backup regular do banco de dados
   - Disaster recovery plan
   - 2FA para acesso admin

---

## üß™ Estrat√©gia de Testes

### Cobertura M√≠nima: 80%

1. **Unit Tests**
   - Testar l√≥gica de neg√≥cio isoladamente
   - Mock de depend√™ncias externas
   - Testar edge cases

2. **Integration Tests**
   - Testar integra√ß√£o com exchanges (testnet)
   - Testar persist√™ncia no banco
   - Testar plugin loading

3. **E2E Tests**
   - Simular fluxo completo de trading
   - Testar cen√°rios de erro
   - Testar recovery de falhas

4. **Performance Tests**
   - Load testing de estrat√©gias
   - Latency de execu√ß√£o de ordens
   - Memory leaks

---

## üìä M√©tricas de Sucesso

### MVP (M√™s 1)
- ‚úÖ Executar trades em 2 exchanges
- ‚úÖ 2 estrat√©gias funcionais
- ‚úÖ Stop loss/take profit operacional
- ‚úÖ 100% de trades registrados
- ‚úÖ Zero perda de dados
- ‚úÖ Cobertura de testes > 70%

### Produ√ß√£o (M√™s 6)
- ‚úÖ Uptime > 99%
- ‚úÖ Lat√™ncia de execu√ß√£o < 500ms
- ‚úÖ Sharpe Ratio > 1.5
- ‚úÖ Win Rate > 55%
- ‚úÖ Maximum Drawdown < 15%
- ‚úÖ Zero security incidents

---

## üõ†Ô∏è Ferramentas e Bibliotecas Recomendadas

### Core
- **ccxt**: Integra√ß√£o multi-exchange (v4.2+)
- **sqlalchemy**: ORM (v2.0+)
- **alembic**: Database migrations
- **pydantic**: Data validation (v2.0+)
- **python-dotenv**: Environment variables

### Data & Analysis
- **pandas**: Data manipulation
- **numpy**: Numerical computing
- **ta-lib**: Technical analysis (opcional, usar pandas-ta como alternativa)
- **pandas-ta**: Technical indicators

### Async & Concurrency
- **asyncio**: Async framework nativo
- **aiohttp**: Async HTTP client
- **asyncpg**: Async PostgreSQL driver

### Testing
- **pytest**: Test framework
- **pytest-asyncio**: Async testing
- **pytest-cov**: Coverage
- **faker**: Mock data generation
- **freezegun**: Time mocking

### Code Quality
- **black**: Code formatter
- **flake8**: Linter
- **mypy**: Type checker
- **isort**: Import sorter
- **bandit**: Security linter

### Logging & Monitoring
- **structlog**: Structured logging
- **prometheus-client**: Metrics (futuro)
- **sentry-sdk**: Error tracking (futuro)

### CLI
- **click**: CLI framework
- **rich**: Terminal formatting

---

## üìù Formato de Configura√ß√£o

### config.yaml (exemplo)
```yaml
environment: production  # dev, staging, production

database:
  host: ${DB_HOST}
  port: 5432
  name: cripto_bot
  user: ${DB_USER}
  password: ${DB_PASSWORD}

exchanges:
  binance:
    enabled: true
    testnet: false
    api_key: ${BINANCE_API_KEY}
    api_secret: ${BINANCE_API_SECRET}
    rate_limit: 1200
  coinbase:
    enabled: true
    testnet: false
    api_key: ${COINBASE_API_KEY}
    api_secret: ${COINBASE_API_SECRET}

trading:
  dry_run: false  # se true, n√£o executa ordens reais
  max_concurrent_trades: 5
  default_order_type: limit

risk_management:
  max_position_size_pct: 10.0  # % do capital total
  max_portfolio_risk_pct: 30.0
  default_stop_loss_pct: 2.0
  default_take_profit_pct: 5.0
  trailing_stop: true
  trailing_stop_distance_pct: 1.0
  max_drawdown_pct: 15.0

strategies:
  - name: rsi_mean_reversion
    enabled: true
    pairs:
      - BTC/USDT
      - ETH/USDT
    timeframe: 1h
    parameters:
      rsi_period: 14
      rsi_oversold: 30
      rsi_overbought: 70
      
  - name: macd_crossover
    enabled: true
    pairs:
      - BTC/USDT
    timeframe: 4h
    parameters:
      fast_period: 12
      slow_period: 26
      signal_period: 9

logging:
  level: INFO
  format: json
  output: both  # console, file, both
  file_path: logs/bot.log
  max_file_size_mb: 50
  backup_count: 10
```

---

## ‚úÖ Definition of Done (DoD)

Para cada feature ser considerada "completa":

1. ‚úÖ C√≥digo implementado seguindo PEP 8
2. ‚úÖ Type hints em todas as fun√ß√µes
3. ‚úÖ Docstrings completas
4. ‚úÖ Testes unit√°rios com cobertura > 80%
5. ‚úÖ Testes de integra√ß√£o passando
6. ‚úÖ Par√¢metros configur√°veis (n√£o hardcoded)
7. ‚úÖ Logging apropriado
8. ‚úÖ Error handling robusto
9. ‚úÖ Valida√ß√£o de inputs
10. ‚úÖ Code review aprovado
11. ‚úÖ Sem warnings de linter
12. ‚úÖ Documenta√ß√£o atualizada

---

## üéì Considera√ß√µes de um Trader Experiente

### Princ√≠pios de Trading
1. **Preserve Capital**: A prioridade #1 √© n√£o perder dinheiro
2. **Risk Management > Strategy**: Gest√£o de risco √© mais importante que a estrat√©gia de entrada
3. **Consistency**: Resultados consistentes > trades espetaculares espor√°dicos
4. **Backtest, mas n√£o confie cegamente**: Overfitting √© real
5. **Paper trade antes de produ√ß√£o**: SEMPRE teste com dinheiro fake primeiro
6. **Start Small**: Comece com capital pequeno, escale gradualmente
7. **Market Conditions Matter**: O que funciona em bull market pode falhar em bear market
8. **Slippage & Fees**: Em produ√ß√£o, comiss√µes e slippage comem muito do lucro
9. **Liquidity First**: Trade apenas pares com boa liquidez
10. **Psychology**: Remova emo√ß√£o da equa√ß√£o (por isso rob√¥s s√£o √∫teis)

### Armadilhas Comuns
- ‚ùå Overtrading (excesso de opera√ß√µes)
- ‚ùå Revenge trading (tentar recuperar perdas)
- ‚ùå N√£o usar stop loss
- ‚ùå Position size grande demais
- ‚ùå Ignorar market context
- ‚ùå Curve fitting no backtest
- ‚ùå N√£o considerar custos operacionais

### M√©tricas que Importam
1. **Sharpe Ratio**: Retorno ajustado ao risco
2. **Maximum Drawdown**: Maior queda do pico
3. **Win Rate**: % de trades vencedores
4. **Profit Factor**: Lucro total / Perda total
5. **Average Win vs Average Loss**: Deve ser > 1
6. **Expectancy**: Lucro m√©dio esperado por trade
7. **Recovery Factor**: Lucro l√≠quido / Max drawdown

---

## üìû Pr√≥ximos Passos

1. **Review deste documento**: Validar requisitos e prioridades
2. **Setup do ambiente**: Python 3.12, PostgreSQL, depend√™ncias
3. **Inicializar Task Master AI**: Para gest√£o de tarefas
4. **Criar estrutura de projeto**: Seguir arquitetura DDD proposta
5. **Implementar MVP sprint by sprint**:
   - Sprint 1: Database + Config System
   - Sprint 2: Core Trading Engine
   - Sprint 3: Plugins (Exchanges + Indicators)
   - Sprint 4: Strategies + Risk Management
   - Sprint 5: Testing + Refinements

---

**Documento criado para otimiza√ß√£o de desenvolvimento com IA (Cursor)**
**Vers√£o**: 1.0
**Data**: Outubro 2025
**Objetivo**: MVP em 30 dias + Roadmap de evolu√ß√£o
