name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "${{ matrix.python-version }}"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'pyproject.toml') }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Lint - Ruff
        run: ruff check --config=pyproject.toml .
      - name: Format - Black
        run: black --check .
      - name: Type check - MyPy
        run: mypy src/crypto_bot
      - name: Tests
        run: pytest --cov=src/crypto_bot --cov-report=term-missing

name: 🚀 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job básico para validar configurações iniciais
  validate-config:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 🐍 Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: 📋 Validate project structure
      run: |
        echo "✅ Validating project structure..."
        test -f README.md && echo "✅ README.md exists"
        test -f REQUISITOS.md && echo "✅ REQUISITOS.md exists"
        test -f .gitignore && echo "✅ .gitignore exists"
        test -f .editorconfig && echo "✅ .editorconfig exists"
        test -f .gitattributes && echo "✅ .gitattributes exists"
        test -d .cursor && echo "✅ .cursor directory exists"
        test -d .taskmaster && echo "✅ .taskmaster directory exists"
        test -d .github && echo "✅ .github directory exists"
        echo "🎉 All essential files present!"

  # Job para validar templates do GitHub
  validate-templates:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 📝 Validate GitHub templates
      run: |
        echo "✅ Validating GitHub templates..."
        test -f .github/pull_request_template.md && echo "✅ PR template exists"
        test -f .github/ISSUE_TEMPLATE/bug_report.md && echo "✅ Bug report template exists"
        test -f .github/ISSUE_TEMPLATE/feature_request.md && echo "✅ Feature request template exists"
        test -f .github/ISSUE_TEMPLATE/task_implementation.md && echo "✅ Task implementation template exists"
        test -f .github/ISSUE_TEMPLATE/security_vulnerability.md && echo "✅ Security vulnerability template exists"
        test -f .github/CODEOWNERS && echo "✅ CODEOWNERS exists"
        test -f .github/labels.yml && echo "✅ Labels configuration exists"
        echo "🎉 All GitHub templates valid!"

  # Job para validar configurações do Task Master AI
  validate-taskmaster:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 🐍 Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: 📋 Validate Task Master AI config
      run: |
        echo "✅ Validating Task Master AI configuration..."
        test -f .taskmaster/config.json && echo "✅ Task Master config exists"
        test -f .taskmaster/docs/prd.txt && echo "✅ PRD exists"
        test -f .taskmaster/tasks/tasks.json && echo "✅ Tasks file exists"
        test -d .taskmaster/templates && echo "✅ Templates directory exists"
        echo "🎉 Task Master AI configuration valid!"

  # Job para validar configurações do Cursor
  validate-cursor:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 📋 Validate Cursor configuration
      run: |
        echo "✅ Validating Cursor configuration..."
        test -f .cursor/mcp.json && echo "✅ MCP configuration exists"
        test -d .cursor/rules && echo "✅ Rules directory exists"
        test -f .cursor/rules/cursor_rules.mdc && echo "✅ Cursor rules exist"
        test -f .cursor/rules/self_improve.mdc && echo "✅ Self improve rules exist"
        test -d .cursor/rules/taskmaster && echo "✅ Task Master rules directory exists"
        echo "🎉 Cursor configuration valid!"

  # Job para validar arquivos de configuração
  validate-config-files:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: 📋 Validate configuration files
      run: |
        echo "✅ Validating configuration files..."
        
        # Validar .gitignore
        if grep -q "Python" .gitignore; then
          echo "✅ .gitignore contains Python patterns"
        fi
        if grep -q "Database" .gitignore; then
          echo "✅ .gitignore contains Database patterns"
        fi
        if grep -q "Crypto Trading Bot" .gitignore; then
          echo "✅ .gitignore contains project-specific patterns"
        fi
        
        # Validar .editorconfig
        if grep -q "Python" .editorconfig; then
          echo "✅ .editorconfig contains Python configuration"
        fi
        
        # Validar .gitattributes
        if grep -q "Python" .gitattributes; then
          echo "✅ .gitattributes contains Python configuration"
        fi
        
        echo "🎉 All configuration files valid!"