name: CI
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "${{ matrix.python-version }}"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'pyproject.toml') }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Lint - Ruff
        run: ruff check --config=pyproject.toml .
      - name: Format - Black
        run: black --check .
      - name: Type check - MyPy
        run: mypy src/crypto_bot
      - name: Tests
        run: pytest --cov=src/crypto_bot --cov-report=term-missing

name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job bÃ¡sico para validar configuraÃ§Ãµes iniciais
  validate-config:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“‹ Validate project structure
      run: |
        echo "âœ… Validating project structure..."
        test -f README.md && echo "âœ… README.md exists"
        test -f REQUISITOS.md && echo "âœ… REQUISITOS.md exists"
        test -f .gitignore && echo "âœ… .gitignore exists"
        test -f .editorconfig && echo "âœ… .editorconfig exists"
        test -f .gitattributes && echo "âœ… .gitattributes exists"
        test -d .cursor && echo "âœ… .cursor directory exists"
        test -d .taskmaster && echo "âœ… .taskmaster directory exists"
        test -d .github && echo "âœ… .github directory exists"
        echo "ğŸ‰ All essential files present!"

  # Job para validar templates do GitHub
  validate-templates:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“ Validate GitHub templates
      run: |
        echo "âœ… Validating GitHub templates..."
        test -f .github/pull_request_template.md && echo "âœ… PR template exists"
        test -f .github/ISSUE_TEMPLATE/bug_report.md && echo "âœ… Bug report template exists"
        test -f .github/ISSUE_TEMPLATE/feature_request.md && echo "âœ… Feature request template exists"
        test -f .github/ISSUE_TEMPLATE/task_implementation.md && echo "âœ… Task implementation template exists"
        test -f .github/ISSUE_TEMPLATE/security_vulnerability.md && echo "âœ… Security vulnerability template exists"
        test -f .github/CODEOWNERS && echo "âœ… CODEOWNERS exists"
        test -f .github/labels.yml && echo "âœ… Labels configuration exists"
        echo "ğŸ‰ All GitHub templates valid!"

  # Job para validar configuraÃ§Ãµes do Task Master AI
  validate-taskmaster:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: ğŸ“‹ Validate Task Master AI config
      run: |
        echo "âœ… Validating Task Master AI configuration..."
        test -f .taskmaster/config.json && echo "âœ… Task Master config exists"
        test -f .taskmaster/docs/prd.txt && echo "âœ… PRD exists"
        test -f .taskmaster/tasks/tasks.json && echo "âœ… Tasks file exists"
        test -d .taskmaster/templates && echo "âœ… Templates directory exists"
        echo "ğŸ‰ Task Master AI configuration valid!"

  # Job para validar configuraÃ§Ãµes do Cursor
  validate-cursor:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“‹ Validate Cursor configuration
      run: |
        echo "âœ… Validating Cursor configuration..."
        test -f .cursor/mcp.json && echo "âœ… MCP configuration exists"
        test -d .cursor/rules && echo "âœ… Rules directory exists"
        test -f .cursor/rules/cursor_rules.mdc && echo "âœ… Cursor rules exist"
        test -f .cursor/rules/self_improve.mdc && echo "âœ… Self improve rules exist"
        test -d .cursor/rules/taskmaster && echo "âœ… Task Master rules directory exists"
        echo "ğŸ‰ Cursor configuration valid!"

  # Job para validar arquivos de configuraÃ§Ã£o
  validate-config-files:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“‹ Validate configuration files
      run: |
        echo "âœ… Validating configuration files..."
        
        # Validar .gitignore
        if grep -q "Python" .gitignore; then
          echo "âœ… .gitignore contains Python patterns"
        fi
        if grep -q "Database" .gitignore; then
          echo "âœ… .gitignore contains Database patterns"
        fi
        if grep -q "Crypto Trading Bot" .gitignore; then
          echo "âœ… .gitignore contains project-specific patterns"
        fi
        
        # Validar .editorconfig
        if grep -q "Python" .editorconfig; then
          echo "âœ… .editorconfig contains Python configuration"
        fi
        
        # Validar .gitattributes
        if grep -q "Python" .gitattributes; then
          echo "âœ… .gitattributes contains Python configuration"
        fi
        
        echo "ğŸ‰ All configuration files valid!"